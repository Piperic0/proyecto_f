<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Funciones - CineApp</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="css/funciones.css" />
</head>
<body>
  <!-- Header y Navbar -->
  <header class="header">
  <div class="logo">
    <a href="index.html"><i class="fas fa-film"></i> CineApp</a>
  </div>
  <nav class="navbar">
    <a href="peliculas.html">Cartelera</a>
    <a href="funciones.html">Funciones</a>
    <a href="reservas.html">Reservas</a>
    <a href="consultas.html">Consultas</a>
  </nav>
</header>

  <!-- Contenido principal -->
  <div class="main-content">
    <div class="bienvenida">
      <h1>üìÖ Funciones Disponibles</h1>
      <p>Consulta las funciones programadas para nuestras pel√≠culas en <span class="resaltado">CineApp</span>.</p>
    </div>

    <!-- Tabla de Funciones -->
    <div class="seccion tabla-seccion">
      <h2>Funciones Programadas</h2>
      <div id="loading" class="text-center py-4">
        <i class="fas fa-spinner fa-spin fa-2x" style="color: #facc15;"></i>
        <p class="mt-2" style="color: #ccc;">Cargando funciones...</p>
      </div>
      <div class="tabla-container" id="tablaContainer" style="display: none;">
        <table class="tabla-funciones">
          <thead>
            <tr>
              <th>ID</th>
              <th>Pel√≠cula</th>
              <th>Sala</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaFunciones">
            <!-- Se cargan funciones con JS -->
          </tbody>
        </table>
      </div>
      <div id="error-container" style="display: none;" class="text-center py-4">
        <i class="fas fa-exclamation-triangle fa-2x" style="color: #ff6b6b;"></i>
        <p id="error-message" class="mt-2 error-msg">Error al cargar datos.</p>
        <button id="retry-button" class="btn-accion mt-3">
          <i class="fas fa-sync"></i> Reintentar
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    &copy; 2025 CineApp. Todos los derechos reservados.
  </footer>

  <!-- JS -->
  <script>
    const API = 'http://localhost:5000/api';
    const loadingElement = document.getElementById('loading');
    const tableContainer = document.getElementById('tablaContainer');
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');
    const retryButton = document.getElementById('retry-button');
    const tablaFunciones = document.getElementById('tablaFunciones');

    retryButton.addEventListener('click', () => {
      showLoading();
      cargarFunciones();
    });

    function showLoading() {
      loadingElement.style.display = 'block';
      tableContainer.style.display = 'none';
      errorContainer.style.display = 'none';
    }

    function showError(mensaje) {
      loadingElement.style.display = 'none';
      tableContainer.style.display = 'none';
      errorContainer.style.display = 'block';
      errorMessage.textContent = mensaje || 'Error al cargar datos. Intente nuevamente m√°s tarde.';
    }

    function showTable() {
      loadingElement.style.display = 'none';
      tableContainer.style.display = 'block';
      errorContainer.style.display = 'none';
    }

    async function fetchWithTimeout(url, options = {}, timeout = 8000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const response = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(id);
        return response;
      } catch (error) {
        clearTimeout(id);
        throw error;
      }
    }

    async function cargarFunciones() {
      try {
        showLoading();
        const resFunciones = await fetchWithTimeout(`${API}/funciones`);
        if (!resFunciones.ok) throw new Error(`Error al cargar funciones: ${resFunciones.status}`);
        const funciones = await resFunciones.json();

        const resPeliculas = await fetchWithTimeout(`${API}/peliculas`);
        if (!resPeliculas.ok) throw new Error(`Error al cargar pel√≠culas: ${resPeliculas.status}`);
        const pelis = await resPeliculas.json();

        const resSalas = await fetchWithTimeout(`${API}/salas`);
        if (!resSalas.ok) throw new Error(`Error al cargar salas: ${resSalas.status}`);
        const salas = await resSalas.json();

        const getPelicula = id => {
          const pelicula = pelis.find(p => p.pelicula_id == id);
          if (pelicula) {
            const img = pelicula.imagen || `https://via.placeholder.com/80x120?text=${encodeURIComponent(pelicula.titulo)}`;
            return `
              <div class="pelicula-info">
                <img src="${img}" alt="${pelicula.titulo}" class="pelicula-thumb">
                <span>${pelicula.titulo}</span>
              </div>
            `;
          } else {
            return `<span>Pel√≠cula ${id}</span>`;
          }
        };

        const getSala = id => {
          const sala = salas.find(s => s.sala_id == id);
          return sala ? sala.nombre : `Sala ${id}`;
        };

        tablaFunciones.innerHTML = '';

        if (funciones.length === 0) {
          tablaFunciones.innerHTML = '<tr><td colspan="6" class="no-data">No hay funciones disponibles</td></tr>';
          showTable();
          return;
        }

        for (const funcion of funciones) {
          const peliculaHTML = getPelicula(funcion.pelicula_id);
          const sala = getSala(funcion.sala_id);
          const fecha = new Date(funcion.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${funcion.funcion_id}</td>
            <td>${peliculaHTML}</td>
            <td>${sala}</td>
            <td>${fecha}</td>
            <td>${funcion.hora}</td>
            <td>
              <button class="btn-accion" onclick="verReservas(${funcion.funcion_id})">
                <i class="fas fa-ticket-alt"></i> Ver reservas
              </button>
            </td>
          `;
          tablaFunciones.appendChild(row);
        }

        showTable();
      } catch (error) {
        console.error("Error al cargar las funciones:", error);
        showError(error.message || "Error al conectar con el servidor.");
      }
    }

    async function verReservas(funcionId) {
      try {
        const response = await fetch(`${API}/consultas/reservas-funcion/${funcionId}`);
        if (!response.ok) throw new Error(`Error al cargar reservas (${response.status})`);
        const reservas = await response.json();

        const existing = document.querySelector(`.reservas-fila[data-id="${funcionId}"]`);
        if (existing) {
          existing.remove();
          return;
        }
        document.querySelectorAll('.reservas-fila').forEach(fila => fila.remove());

        const fila = document.querySelector(`button[onclick="verReservas(${funcionId})"]`).closest('tr');
        const newRow = document.createElement('tr');
        newRow.classList.add('reservas-fila');
        newRow.setAttribute('data-id', funcionId);

        const colspan = fila.children.length;
        const contenido = reservas.length === 0
          ? '<p class="sin-reservas">No hay reservas para esta funci√≥n.</p>'
          : `<ul class="lista-reservas">${reservas.map(r => `<li><strong>${r.nombre_cliente}</strong> reserv√≥ ${r.cantidad} entradas</li>`).join('')}</ul>`;

        newRow.innerHTML = `<td colspan="${colspan}">${contenido}</td>`;
        fila.parentNode.insertBefore(newRow, fila.nextSibling);
      } catch (error) {
        console.error("Error al obtener reservas:", error);
        alert("No se pudieron cargar las reservas: " + error.message);
      }
    }

    window.addEventListener('DOMContentLoaded', cargarFunciones);
  </script>
</body>
</html>

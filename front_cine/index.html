<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cine App - Reservas</title>
  <link rel="stylesheet" href="css/vista.css" />
</head>
<body>
  <header>
    <h1>üé¨ CineApp</h1>
    <p>Reserva tus entradas de forma r√°pida y sencilla</p>
  </header>

  <main>
    <section class="card">
      <h2>üìΩÔ∏è Pel√≠culas</h2>
      <button onclick="cargarPeliculas()">Cargar Pel√≠culas</button>
      <div class="table-wrapper">
        <table id="tablaPeliculas">
          <thead>
            <tr><th>ID</th><th>T√≠tulo</th><th>G√©nero</th><th>Duraci√≥n</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>üìÖ Funciones</h2>
      <button onclick="cargarFunciones()">Cargar Funciones</button>
      <div class="table-wrapper">
        <table id="tablaFunciones">
          <thead>
            <tr><th>ID</th><th>T√≠tulo</th><th>Sala</th><th>Fecha</th><th>Hora</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>üéüÔ∏è Hacer Reserva</h2>
      <form onsubmit="crearReserva(event)">
        <select id="funcionId" required></select>
        <input type="text" id="nombreCliente" placeholder="Nombre del cliente" required />
        <input type="number" id="cantidad" placeholder="Cantidad de entradas" required />
        <button type="submit">Reservar</button>
      </form>
      <p id="reservaMensaje" class="mensaje"></p>
    </section>

    <section class="card">
      <h2>üîç Consultar Reservas por Funci√≥n</h2>
      <select id="consultaFuncionId">
        <option value="">Seleccione una funci√≥n</option>
      </select>
      <button onclick="consultarReservas()">Consultar</button>
      <div class="table-wrapper">
        <table id="tablaReservas">
          <thead>
            <tr><th>Cliente</th><th>Cantidad</th><th>Pel√≠cula</th><th>Sala</th><th>Fecha</th><th>Hora</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 CineApp. Todos los derechos reservados.</p>
  </footer>

  <script>
    const API = 'http://localhost:5000/api';

    function formatearFecha(fechaISO) {
      const date = new Date(fechaISO);
      return date.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }

    async function cargarPeliculas() {
      const res = await fetch(`${API}/peliculas`);
      const data = await res.json();
      const tbody = document.querySelector('#tablaPeliculas tbody');
      tbody.innerHTML = '';
      data.forEach(p => {
        tbody.innerHTML += `<tr><td>${p.pelicula_id}</td><td>${p.titulo}</td><td>${p.genero}</td><td>${p.duracion}</td></tr>`;
      });
    }

    async function cargarFunciones() {
      const res = await fetch(`${API}/funciones`);
      const funciones = await res.json();

      const pelis = await fetch(`${API}/peliculas`).then(r => r.json());
      const salas = await fetch(`${API}/salas`).then(r => r.json());

      const getTitulo = id => (pelis.find(p => p.pelicula_id == id) || {}).titulo || `Pel√≠cula ${id}`;
      const getSala = id => (salas.find(s => s.sala_id == id) || {}).nombre || `Sala ${id}`;

      const tbody = document.querySelector('#tablaFunciones tbody');
      const selectReserva = document.getElementById('funcionId');
      const selectConsulta = document.getElementById('consultaFuncionId');

      tbody.innerHTML = '';
      selectReserva.innerHTML = '';
      selectConsulta.innerHTML = '<option value="">Seleccione una funci√≥n</option>';

      for (const f of funciones) {
        const titulo = getTitulo(f.pelicula_id);
        const sala = getSala(f.sala_id);
        const fechaBonita = formatearFecha(f.fecha);

        tbody.innerHTML += `<tr>
          <td>${f.funcion_id}</td>
          <td>${titulo}</td>
          <td>${sala}</td>
          <td>${fechaBonita}</td>
          <td>${f.hora}</td>
        </tr>`;

        const texto = `${titulo} | ${sala} | ${fechaBonita} ${f.hora}`;
        const option = `<option value="${f.funcion_id}">${texto}</option>`;
        selectReserva.innerHTML += option;
        selectConsulta.innerHTML += option;
      }
    }

    async function crearReserva(e) {
      e.preventDefault();
      const funcion_id = document.getElementById('funcionId').value;
      const nombre_cliente = document.getElementById('nombreCliente').value;
      const cantidad = document.getElementById('cantidad').value;

      const res = await fetch(`${API}/reservas`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ funcion_id, nombre_cliente, cantidad })
      });

      const result = await res.json();
      const mensaje = document.getElementById('reservaMensaje');
      mensaje.innerText = result.message || result.error;

      // ‚úÖ Limpiar campos del formulario
      document.getElementById('funcionId').value = '';
      document.getElementById('nombreCliente').value = '';
      document.getElementById('cantidad').value = '';

      // ‚úÖ Ocultar mensaje despu√©s de 3 segundos
      setTimeout(() => {
        mensaje.innerText = '';
      }, 3000);
    }

    async function consultarReservas() {
      const id = document.getElementById('consultaFuncionId').value;
      if (!id) return alert('Selecciona una funci√≥n');

      const res = await fetch(`${API}/consultas/reservas-funcion/${id}`);
      const data = await res.json();
      const tbody = document.querySelector('#tablaReservas tbody');
      tbody.innerHTML = '';
      data.forEach(r => {
        const fechaBonita = formatearFecha(r.fecha);
        tbody.innerHTML += `<tr>
          <td>${r.nombre_cliente}</td>
          <td>${r.cantidad}</td>
          <td>${r.titulo}</td>
          <td>${r.sala}</td>
          <td>${fechaBonita}</td>
          <td>${r.hora}</td>
        </tr>`;
      });

      // ‚úÖ Limpiar select despu√©s de consultar
      document.getElementById('consultaFuncionId').value = '';
    }

    // Cargar funciones autom√°ticamente
    window.addEventListener('DOMContentLoaded', () => {
      cargarFunciones();
    });
  </script>
</body>
</html>
